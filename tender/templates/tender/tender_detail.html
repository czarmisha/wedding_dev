{% extends 'tender_base.html' %}


{% block content %}
<a href="{% url 'home' %}">home</a>
<h1>Tender detail</h1>
<ul>
    <p>Нужен: <b>{{tender.get_service_display}}</b></p>
    <p>Автор: {{tender.author.username}}</p>
    <p>Бюджет: {{tender.budget}} сум</p>
    <p>Описание: {{tender.comment}}</p>
    <p>На {{tender.on_date}}</p>
    <br>
    <p>Количетсво откликов на тендер: {{tender.responses.count}}</p>

    {%if tender.author == request.user%}
        <a href="{%url 'tender:update' tender.slug%}">Редактировать</a>
        <a href="{%url 'tender:delete' tender.slug%}">Удалить</a>
        <h3>Отклики:</h3>
        {% for response in tender.responses.all%}
            {% if response.from_user.type == 'photographer' %}
                <a href="{{response.from_user.photographer.get_absolute_url}}">{{response.from_user}}</a>
            {% elif response.from_user.type == 'restaurant' %}
                <a href="{{response.from_user.restaurant.get_absolute_url}}">{{response.from_user}}</a>
            {% endif %}
        {%endfor%}
    {%endif%}
    {%if tender.executor%}
        <p>Тендер закрыт. Исполнитель найден</p>
    {%else%}
        {%if responded%}
            <span>Вы откликнулись</span>
        {%elif tender.service == request.user.type%}
            <a href="" class="createResponse">Откликнуться на тендер</a>
        {%endif%}
    {%endif%}

</ul>

{% endblock %}
{%block script%}
<script>
    // let btn = document.querySelector('.createResponse');
    // btn.addEventListener('click', function(e){
    //     e.preventDefault();
    // })
    $(document).ready(function() {
      $('.createResponse').click(function(e) {
        // Stop form from sending request to server
        e.preventDefault();

        var btn = $(this);

        $.ajax({
          method: "POST",
          url: "{% url 'tender:create_response' %}",
          dataType: "json",
          data: {
              'csrfmiddlewaretoken': "{{ csrf_token }}",
              "tender_pk": '{{tender.pk}}',
              "user_pk": '{{request.user.pk}}',
          },
          success: function(data) {
            if(data['success'])window.location.reload()
          },
          error: function(er) {
            console.log(er);
          }
        });
      })
    });
</script>
{%endblock%}
